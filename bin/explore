#!/usr/bin/env python3

import os
import sys
sys.path.append(os.path.join(os.path.dirname(__file__), '..'))

from prediction import Config
from prediction import Explorer
from prediction import Input
from prediction import Learner
from prediction import Random
from prediction import Session
from prediction import support
import argparse

def main(config):
    support.loggalize()
    Random.initialize(config.seed)
    input = Input(config.session.input)
    path = config.session.output.get('path', support.default_output())
    config.session.output.path = os.path.join(path, 'reference')
    learner = Learner(config.session.learner.reference)
    session = Session(input, learner, config.session)
    session.run_comparison('testing')
    config.session.output.path = path
    explorer = Explorer(input, config)
    case, step_count = explorer.run()
    config = explorer.configure(case, restore=step_count)
    learner = Learner(config.learner.candidate)
    session = Session(input, learner, config)
    session.run_comparison('testing')

if __name__ == '__main__':
    parser = argparse.ArgumentParser()
    parser.add_argument('--config', required=True)
    parser.add_argument('--input')
    parser.add_argument('--output')
    arguments = parser.parse_args()
    config = Config.load(arguments.config)
    if isinstance(config.session, str):
        config.session = Config.load(config.session)
    if arguments.input is not None:
        config.session.input.path = arguments.input
    if arguments.output is not None:
        config.session.output.path = arguments.output
    main(config)
