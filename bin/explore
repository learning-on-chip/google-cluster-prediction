#!/usr/bin/env python3

import os
import sys
sys.path.append(os.path.join(os.path.dirname(__file__), '..'))

from prediction import Baseline
from prediction import Comparator
from prediction import Config
from prediction import Explorer
from prediction import Input
from prediction import Random
from prediction import support
import argparse
import json

def main(config):
    support.loggalize()
    Random.initialize(config.seed)
    compatator = Comparator()
    input = Input(config.learner.input)
    path = config.learner.output.get('path', support.default_output())
    config.learner.output.path = os.path.join(path, 'baseline')
    baseline = Baseline(input, config.learner)
    compatator.run(baseline, 'test')
    config.learner.output.path = path
    explorer = Explorer(input, config)
    case, step_count = explorer.run()
    config = explorer.configure(case, 'test', restore=step_count)
    config.output.path = os.path.join(path, 'learner')
    learner = Learner(input, config)
    compatator.run(learner, 'test')

if __name__ == '__main__':
    parser = argparse.ArgumentParser()
    parser.add_argument('--config', required=True)
    parser.add_argument('--input')
    parser.add_argument('--output')
    arguments = parser.parse_args()
    config = Config(json.loads(open(arguments.config).read()))
    if isinstance(config.learner, str):
        config.learner = Config(json.loads(open(config.learner).read()))
    if arguments.input is not None:
        config.learner.input.path = arguments.input
    if arguments.output is not None:
        config.learner.output.path = arguments.output
    main(config)
